# ๐ฌ Mail Collector Service โ ุงูุชูุซูู ุงููุงูู

> **ูุธุงู ุฌูุน ูุชุญููู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู** โ ุฑุจุท ุญุณุงุจุงุช Outlook/Microsoft 365 ูุชุนุฏุฏุฉ ูุชูุฌูู ูู ุงูุฑุณุงุฆู ุงููุงุฑุฏุฉ ุฅูู ุจุฑูุฏ ููุญุฏ ุนุจุฑ Microsoft Graph API.

---

## ๐ ุฌุฏูู ุงููุญุชููุงุช

- [ูุธุฑุฉ ุนุงูุฉ](#-ูุธุฑุฉ-ุนุงูุฉ)
- [ุงููุชุทูุจุงุช](#-ุงููุชุทูุจุงุช)
- [ุงูุชุซุจูุช ูุงูุฅุนุฏุงุฏ](#-ุงูุชุซุจูุช-ูุงูุฅุนุฏุงุฏ)
- [ุฅุนุฏุงุฏ Azure App](#-ุฅุนุฏุงุฏ-azure-app)
- [ููู .env](#-ููู-env)
- [ุชุดุบูู ุงููุดุฑูุน](#-ุชุดุบูู-ุงููุดุฑูุน)
- [ุตูุญุงุช ุงููุงุฌูุฉ](#-ุตูุญุงุช-ุงููุงุฌูุฉ)
- [API Endpoints](#-api-endpoints)
- [ูุงุนุฏุฉ ุงูุจูุงูุงุช](#-ูุงุนุฏุฉ-ุงูุจูุงูุงุช)
- [ุงูุฎุฏูุงุช ุงูุฏุงุฎููุฉ](#-ุงูุฎุฏูุงุช-ุงูุฏุงุฎููุฉ)
- [ุขููุฉ ุงูุนูู](#-ุขููุฉ-ุงูุนูู)
- [Rate Limits ูุงูุชุฃุฎูุฑุงุช](#-rate-limits-ูุงูุชุฃุฎูุฑุงุช)
- [ุงูุญุฐู ูุงูุชูุธูู](#-ุงูุญุฐู-ูุงูุชูุธูู)
- [ุงุณุชูุดุงู ุงูุฃุฎุทุงุก](#-ุงุณุชูุดุงู-ุงูุฃุฎุทุงุก)
- [ูููู ุงููููุงุช](#-ูููู-ุงููููุงุช)

---

## ๐ ูุธุฑุฉ ุนุงูุฉ


### ููู ูุนูู ุงููุธุงูุ (ุงูุฅุตุฏุงุฑ ุงูุฌุฏูุฏ โ Webhook)

ุงููุธุงู ุงูุขู ูุนุชูุฏ ุนูู Webhook ูู Microsoft Graph API ุจุฏูุงู ูู Polling ูู 30 ุซุงููุฉ. ุนูุฏ ูุตูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูุฃู ุญุณุงุจุ ูููู Microsoft ุจุฅุฑุณุงู ุฅุดุนุงุฑ (Webhook) ุฅูู ุงูุณูุฑูุฑ ูุฏููุงุ ููุชู ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ ููุฑุงู.

```mermaid
flowchart TD
  subgraph Users
    A1["Outlook Account\\nuser1@..."]
    A2["Outlook Account\\nuser2@..."]
    A3["Outlook Account\\nuser3@..."]
  end
  A1 -->|"Microsoft Graph API\\n(Subscription Webhook)"| B[Webhook Endpoint\\n/api/webhooks/mail]
  A2 -->|"Microsoft Graph API\\n(Subscription Webhook)"| B
  A3 -->|"Microsoft Graph API\\n(Subscription Webhook)"| B
  B -->|"Queue Job"| C["Mail Processor\\n(Worker)"]
  C -->|"Forward via Graph API"| D["๐ง ุงูุจุฑูุฏ ุงูููุญุฏ\\ninfo@xxx.com"]
  C -->|"ุชุฌุฏูุฏ ุงูุชูููุงุช ุชููุงุฆู ูู ุณุงุนุฉ"| E["Token Refresher\\n(Every hour)"]
```

**ุงูููุฎุต:**
- ุนูุฏ ูุตูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูุฃู ุญุณุงุจุ ูุชู ุฅุดุนุงุฑ ุงููุธุงู ููุฑุงู ุนุจุฑ Webhook.
- ุชุชู ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ ูุชุญููููุง ูุจุงุดุฑุฉ ุฅูู ุงูุจุฑูุฏ ุงูููุญุฏ.
- ููุงู ุนูููุฉ ูุฌุฏููุฉ ูู ุณุงุนุฉ ูุชุฌุฏูุฏ ุงูุชูููุงุช ุชููุงุฆูุงู ููุญุณุงุจุงุช ุงูุชู ุชุญุชุงุฌ ุฐูู.

### ุงููููุฒุงุช

- ุฑุจุท ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ ูู ุญุณุงุจุงุช Microsoft/Outlook
- ุชูุฌูู ุชููุงุฆู ุนุจุฑ Graph API (ุจุฏูู SMTP)
- Delta Query โ ุฌูุจ ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ ููุท (ูุง ููุฑุฑ)
- ุชุดููุฑ AES-256 ูุฌููุน ุงูุชูููุงุช
- ุฅุนุงุฏุฉ ูุญุงููุฉ ุชููุงุฆูุฉ ููุฑุณุงุฆู ุงููุงุดูุฉ
- ููุญุฉ ุชุญูู ููุจ ูุงููุฉ
- ุญูุงูุฉ ูู Rate Limits ุจุชุฃุฎูุฑุงุช ูุฏูุฌุฉ
- ุชุฌุฏูุฏ ุชููุงุฆู ููู OAuth tokens

---

## ๐ฆ ุงููุชุทูุจุงุช

| ุงูุจุฑูุงูุฌ                   | ุงูุฅุตุฏุงุฑ     | ุงูุบุฑุถ                     |
| -------------------------- | ----------- | ------------------------- |
| **Node.js**                | >= 18.0.0   | ุชุดุบูู ุงูุณูุฑูุฑ ูุงูู Worker |
| **MySQL**                  | 5.7+ ุฃู 8.0 | ูุงุนุฏุฉ ุงูุจูุงูุงุช            |
| **Redis**                  | 6.0+        | ูุธุงู ุงูู Queue (Bull)     |
| **Azure App Registration** | โ           | ุฑุจุท ุญุณุงุจุงุช Microsoft      |

---

## ๐ ุงูุชุซุจูุช ูุงูุฅุนุฏุงุฏ

### 1. ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช

```bash
npm install
```

### 2. ูุณุฎ ููู ุงูุฅุนุฏุงุฏุงุช

```bash
cp .env
```

### 3. ุชุนุฏูู `.env` (ุฑุงุฌุน ุงููุณู ุงูุชุงูู)

### 4. ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช

```bash
# ุชูููุฏ Prisma Client
npm run db:generate

# ุชุทุจูู ุงูู Schema ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
npm run db:push

# ุฃู ุจุงูู Migrations
npm run db:migrate

# ุฅูุดุงุก ุญุณุงุจ ุงูุฃุฏูู ุงูุงูุชุฑุงุถู
npm run db:seed
```

### 5. ุฃู ุงุณุชุฎุฏู ุงูุฅุนุฏุงุฏ ุงูุชููุงุฆู

```bash
npm run setup
```

> ูุนูู: generate โ push โ seed โ ุฅูุดุงุก ูุฌูุฏ logs

---

## โ๏ธ ุฅุนุฏุงุฏ Azure App

### ุฎุทูุงุช ุงูุชุณุฌูู ูู Azure Portal

1. ุงุฐูุจ ุฅูู [Azure Portal](https://portal.azure.com)
2. **Microsoft Entra ID** โ **App registrations** โ **New registration**
3. ุงูุฅุนุฏุงุฏุงุช:
   - **Name:** `Mail Collector Service`
   - **Supported account types:** `Accounts in any organizational directory and personal Microsoft accounts`
   - **Redirect URI:** `Web` โ `http://localhost:5000/api/auth/microsoft/callback`
4. ุจุนุฏ ุงูุฅูุดุงุก:
   - ุงูุณุฎ **Application (client) ID** โ `MICROSOFT_CLIENT_ID`
   - **Certificates & secrets** โ **New client secret** โ ุงูุณุฎ ุงููููุฉ โ `MICROSOFT_CLIENT_SECRET`

### ุงูุตูุงุญูุงุช ุงููุทููุจุฉ (API Permissions)

| ุงูุตูุงุญูุฉ         | ุงูููุน     | ุงูุบุฑุถ                         |
| ---------------- | --------- | ----------------------------- |
| `User.Read`      | Delegated | ูุฑุงุกุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู         |
| `Mail.Read`      | Delegated | ูุฑุงุกุฉ ุงูุฑุณุงุฆู ูู ุงูู Inbox    |
| `Mail.Send`      | Delegated | ุฅุนุงุฏุฉ ุชูุฌูู ุงูุฑุณุงุฆู (Forward) |
| `offline_access` | Delegated | ุงูุญุตูู ุนูู Refresh Token      |


---

## โ๏ธ ููู .env

```ini
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ุงูุณูุฑูุฑ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
NODE_ENV=development          # development | production
PORT=5000                     # ุจูุฑุช ุงูุณูุฑูุฑ
API_URL=http://localhost:5000 # ุฑุงุจุท ุงูู API (ููู callbacks)
FRONTEND_URL=http://localhost:5000  # ุฑุงุจุท ุงููุงุฌูุฉ

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ูุงุนุฏุฉ ุงูุจูุงูุงุช (MySQL)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
DATABASE_URL="mysql://USER:PASSWORD@HOST:3306/DATABASE_NAME"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Redis (ููู Queue)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=               # ุงุชุฑูู ูุงุถู ูู ุจุฏูู ุจุงุณูุฑุฏ

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# JWT (ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
JWT_SECRET=your-secret-key    # ุบููุฑู ููููุฉ ุนุดูุงุฆูุฉ ูููุฉ
JWT_EXPIRES_IN=7d             # ูุฏุฉ ุตูุงุญูุฉ ุงูุชููู

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ุชุดููุฑ ุงูุชูููุงุช (AES-256)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ENCRYPTION_KEY=0123456789abcdef...  # 64 ุญุฑู hex (32 bytes)

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Microsoft Azure
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
MICROSOFT_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
MICROSOFT_CLIENT_SECRET=xxxxxxxxxxxxx
MICROSOFT_REDIRECT_URI=http://localhost:5000/api/auth/microsoft/callback
MICROSOFT_SCOPES=offline_access User.Read Mail.Read Mail.Send

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ุฅุนุงุฏุฉ ุงูุชูุฌูู
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
FORWARD_TO_EMAIL=your@email.com        # ุงูุจุฑูุฏ ุงูููุญุฏ ุงููู ุชุชุญูู ูู ุงูุฑุณุงุฆู
FORWARD_DELAY_MS=500                   # ุชุฃุฎูุฑ ุจูู ูู forward (ุจุงููููู ุซุงููุฉ)

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SMTP (ุงุฎุชูุงุฑู - ูู ูุนุฏ ูุทููุจุงู)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SMTP_HOST=smtp.example.com
# SMTP_PORT=587
# SMTP_SECURE=false
# SMTP_USER=user@example.com
# SMTP_PASS=password
# SMTP_FROM=Mail Collector <noreply@example.com>

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Worker
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
POLL_INTERVAL_MS=30000        # ูุงุตู ุฒููู ุจูู ุฏูุฑุงุช ุงูุณุญุจ (30 ุซุงููุฉ)
WORKER_CONCURRENCY=5          # ุนุฏุฏ ุงูู jobs ุงููุชุฒุงููุฉ
MAX_RETRIES=5                 # ุฃูุตู ุนุฏุฏ ูุญุงููุงุช ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู
RETRY_DELAY_MS=5000           # ุชุฃุฎูุฑ ุจูู ุงููุญุงููุงุช

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ุญุณุงุจ ุงูุฃุฏูู
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=change-this-password

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ุงูู Logs
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
LOG_LEVEL=info                # info | warn | error | debug
LOG_FILE=logs/app.log
```

---

## โถ๏ธ ุชุดุบูู ุงููุดุฑูุน

### ุฃูุงูุฑ ุงูุชุดุบูู

| ุงูุฃูุฑ                | ุงููุตู                                                    |
| -------------------- | -------------------------------------------------------- |
| `npm run dev`        | ุชุดุบูู ุงูุณูุฑูุฑ + ุงูู Worker ูุนุงู (development ูุน nodemon) |
| `npm run dev:server` | ุชุดุบูู ุงูุณูุฑูุฑ ููุท                                        |
| `npm run dev:worker` | ุชุดุบูู ุงูู Worker ููุท                                     |
| `npm start`          | ุชุดุบูู ุงูุณูุฑูุฑ (production)                               |
| `npm run worker`     | ุชุดุบูู ุงูู Worker (production)                            |
| `npm run prod`       | ุชุดุบูู ุงูุงุซููู ูุนุงู (production)                          |

### ุฃูุงูุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช

| ุงูุฃูุฑ                 | ุงููุตู                                     |
| --------------------- | ----------------------------------------- |
| `npm run db:generate` | ุชูููุฏ Prisma Client                       |
| `npm run db:push`     | ุชุทุจูู ุงูู Schema                          |
| `npm run db:migrate`  | ุฅูุดุงุก ูุชุทุจูู migration                    |
| `npm run db:studio`   | ูุชุญ Prisma Studio (ูุงุฌูุฉ ูุฅุฏุงุฑุฉ ุงูุจูุงูุงุช) |
| `npm run db:seed`     | ุฅูุดุงุก ุญุณุงุจ ุงูุฃุฏูู ุงูุงูุชุฑุงุถู               |

### ููุงุญุธุงุช

- **ุงูุณูุฑูุฑ**: ูุฎุฏู ุงูู API + ุตูุญุงุช ุงูููุจ
- **ุงูู Worker**: ุนูููุฉ ูููุตูุฉ โ ูุณุคูู ุนู ุณุญุจ ุงูุฑุณุงุฆู ูุชุญููููุง
- **Redis ูุทููุจ**: ูุงุฒู Redis ูููู ุดุบุงู ูุจู ุชุดุบูู ุงูู Worker
- ูู ุดุบููุช `npm run dev` ูุดุชุบู ุงูุงุซููู ูุนุงู

---

## ๐ฅ๏ธ ุตูุญุงุช ุงููุงุฌูุฉ

### 1. ุตูุญุฉ ุงูุฏุฎูู โ `/`

| ุงูุนูุตุฑ                  | ุงููุตู                                     |
| ----------------------- | ----------------------------------------- |
| **ุงูุฑุงุจุท**              | `http://localhost:5000/`                  |
| **ุงูููู**               | `public/index.html`                       |
| **ุงููุธููุฉ**             | ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู (ุจุฑูุฏ + ูููุฉ ูุฑูุฑ)      |
| **ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ** | `admin@mail-collector.local` / `admin123` |
| **ุจุนุฏ ุงูุฏุฎูู**          | ูุชู ุงูุชุญููู ุฅูู `/dashboard`              |

---

### 2. ููุญุฉ ุงูุชุญูู โ `/dashboard`

| ุงูุนูุตุฑ      | ุงููุตู                             |
| ----------- | --------------------------------- |
| **ุงูุฑุงุจุท**  | `http://localhost:5000/dashboard` |
| **ุงูููู**   | `public/dashboard.html`           |
| **ุงููุธููุฉ** | ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู              |

**ุงููุญุชูู:**

- **ุฅุญุตุงุฆูุงุช:** ุฅุฌูุงูู ุงูุญุณุงุจุงุชุ ุงููุดุทุฉุ ุจูุง ูุดุงููุ ุงูุฑุณุงุฆู ุงููุญููุฉ
- **ุขุฎุฑ ุงููุดุงุทุงุช:** ุขุฎุฑ ุงูุฑุณุงุฆู ุงููุญููุฉ (ุงูููุชุ ุงูุญุณุงุจุ ุงูููุถูุนุ ุงูุญุงูุฉ)
- **ุฒุฑ "Sync All":** ุชุดุบูู ูุฒุงููุฉ ูุฏููุฉ ููู ุงูุญุณุงุจุงุช

---

### 3. ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช โ `/accounts`

| ุงูุนูุตุฑ      | ุงููุตู                            |
| ----------- | -------------------------------- |
| **ุงูุฑุงุจุท**  | `http://localhost:5000/accounts` |
| **ุงูููู**   | `public/accounts.html`           |
| **ุงููุธููุฉ** | ุฅุฏุงุฑุฉ ุญุณุงุจุงุช Microsoft ุงููุฑุจูุทุฉ  |

**ุงูุนูููุงุช ุงููุชุงุญุฉ:**

| ุงูุนูููุฉ             | ุงููุตู                                      |
| ------------------- | ------------------------------------------ |
| **Connect Account** | ุฑุจุท ุญุณุงุจ ุฌุฏูุฏ (ููุชุญ ุตูุญุฉ Microsoft OAuth)  |
| **Sync**            | ูุฒุงููุฉ ูุฏููุฉ ูุญุณุงุจ ูุงุญุฏ                    |
| **Enable/Disable**  | ุชูุนูู/ุชุนุทูู ุญุณุงุจ (ุงูุชุจุฏูู)                 |
| **Delete**          | ุญุฐู ุญุณุงุจ ููุงุฆูุงู (ูุน ูู ุงูุชูููุงุช ูุงูุณุฌูุงุช) |
| **Sync All**        | ูุฒุงููุฉ ูู ุงูุญุณุงุจุงุช ุฏูุนุฉ ูุงุญุฏุฉ              |

**ุญุงูุงุช ุงูุญุณุงุจ:**

| ุงูุญุงูุฉ         | ุงูููู   | ุงููุนูู                        |
| -------------- | ------- | ----------------------------- |
| `CONNECTED`    | ุฃุฎุถุฑ    | ูุชุตู ููุนูู                    |
| `PENDING`      | ุฃุตูุฑ    | ุจุงูุชุธุงุฑ ุฑุจุท OAuth             |
| `NEEDS_REAUTH` | ุจุฑุชูุงูู | ูุญุชุงุฌ ุฅุนุงุฏุฉ ุชุณุฌูู ุฏุฎูู        |
| `ERROR`        | ุฃุญูุฑ    | ุฎุทุฃ (5 ูุญุงููุงุช ูุงุดูุฉ ูุชุชุงููุฉ) |
| `DISABLED`     | ุฑูุงุฏู   | ูุนุทูู ูุฏููุงู                  |

---

### 4. ุงูุณุฌูุงุช โ `/logs`

| ุงูุนูุตุฑ      | ุงููุตู                        |
| ----------- | ---------------------------- |
| **ุงูุฑุงุจุท**  | `http://localhost:5000/logs` |
| **ุงูููู**   | `public/logs.html`           |
| **ุงููุธููุฉ** | ุนุฑุถ ุณุฌูุงุช ุงูุฑุณุงุฆู ูุงููุธุงู    |

**ููุนูู ูู ุงูุณุฌูุงุช:**

| ุงูููุน            | ุงูุฃุนูุฏุฉ                                  |
| ---------------- | ---------------------------------------- |
| **Message Logs** | ุงูููุชุ ููุ ุฅูู (ุงูุญุณุงุจ)ุ ุงูููุถูุนุ ุงูุญุงูุฉ |
| **System Logs**  | ุงูููุชุ ุงููุณุชููุ ุงููุฆุฉุ ุงูุฑุณุงูุฉ           |

**ุญุงูุงุช ุงูุฑุณุงูุฉ:**

| ุงูุญุงูุฉ      | ุงููุนูู            |
| ----------- | ----------------- |
| `FORWARDED` | ุชู ุงูุชุญููู ุจูุฌุงุญ  |
| `FAILED`    | ูุดู ุงูุชุญููู       |
| `PENDING`   | ุจุงูุชุธุงุฑ ุงููุญุงููุฉ  |
| `SKIPPED`   | ุชู ุชุฎุทููุง (ููุฑุฑุฉ) |

---

### 5. ุงูุฅุนุฏุงุฏุงุช โ `/settings`

| ุงูุนูุตุฑ      | ุงููุตู                             |
| ----------- | --------------------------------- |
| **ุงูุฑุงุจุท**  | `http://localhost:5000/settings`  |
| **ุงูููู**   | `public/settings.html`            |
| **ุงููุธููุฉ** | ุฅุนุฏุงุฏุงุช ุงููุธุงู ูุชุบููุฑ ูููุฉ ุงููุฑูุฑ |

**ุงูุฃูุณุงู:**

| ุงููุณู                | ุงููุตู                                                                |
| -------------------- | -------------------------------------------------------------------- |
| **Profile**          | ุนุฑุถ ุจูุงูุงุช ุงูุฃุฏูู (ุงูุงุณูุ ุงูุจุฑูุฏ)                                    |
| **Email Forwarding** | ุชุบููุฑ ุจุฑูุฏ ุฅุนุงุฏุฉ ุงูุชูุฌูู + ุฒุฑ "Test Forward"                         |
| **Change Password**  | ุชุบููุฑ ูููุฉ ูุฑูุฑ ุงูุฃุฏูู                                               |
| **System Info**      | ุงูุฅุตุฏุงุฑุ ุจุฑูุฏ ุงูุชูุฌููุ ุทุฑููุฉ ุงูุชูุฌููุ ูุชุฑุฉ ุงููุฒุงููุฉุ ุญุงูุฉ ุงูู Worker |

---

### 6. OAuth Callback โ `/oauth-callback`

| ุงูุนูุตุฑ      | ุงููุตู                                |
| ----------- | ------------------------------------ |
| **ุงูุฑุงุจุท**  | ูุชู ุงูุชุญููู ุฅูููุง ุชููุงุฆูุงู ุจุนุฏ OAuth |
| **ุงูููู**   | `public/oauth-callback.html`         |
| **ุงููุธููุฉ** | ุนุฑุถ ูุชูุฌุฉ ุฑุจุท ุงูุญุณุงุจ (ูุฌุงุญ/ูุดู)      |

---

## ๐ก API Endpoints

### ุงููุตุงุฏูุฉ โ `/api/auth`

| Method | Endpoint                       | Auth | ุงููุตู                  |
| ------ | ------------------------------ | ---- | ---------------------- |
| `POST` | `/api/auth/login`              | โ   | ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู      |
| `GET`  | `/api/auth/me`                 | โ   | ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู |
| `GET`  | `/api/auth/microsoft/connect`  | โ   | ุชูููุฏ ุฑุงุจุท OAuth       |
| `GET`  | `/api/auth/microsoft/callback` | โ   | Callback ูู Microsoft  |
| `POST` | `/api/auth/change-password`    | โ   | ุชุบููุฑ ูููุฉ ุงููุฑูุฑ      |

#### `POST /api/auth/login`

```json
// Request
{ "email": "admin@mail-collector.local", "password": "admin123" }

// Response
{
  "success": true,
  "data": {
    "token": "eyJhbGci...",
    "user": { "id": "...", "email": "...", "name": "...", "role": "admin" }
  }
}
```

#### `POST /api/auth/change-password`

```json
// Request
{ "currentPassword": "admin123", "newPassword": "newSecurePassword" }

// Response
{ "success": true, "message": "Password changed successfully" }
```

---

### ุงูุญุณุงุจุงุช โ `/api/accounts`

| Method   | Endpoint                      | Auth | ุงููุตู                 |
| -------- | ----------------------------- | ---- | --------------------- |
| `GET`    | `/api/accounts`               | โ   | ูุงุฆูุฉ ูู ุงูุญุณุงุจุงุช     |
| `POST`   | `/api/accounts`               | โ   | ุฅุถุงูุฉ ุญุณุงุจ ุฌุฏูุฏ       |
| `GET`    | `/api/accounts/:id`           | โ   | ุชูุงุตูู ุญุณุงุจ           |
| `PATCH`  | `/api/accounts/:id`           | โ   | ุชุญุฏูุซ (ุชูุนูู/ุชุนุทูู)   |
| `DELETE` | `/api/accounts/:id`           | โ   | ุญุฐู ุญุณุงุจ              |
| `POST`   | `/api/accounts/:id/sync`      | โ   | ูุฒุงููุฉ ุญุณุงุจ ูุงุญุฏ      |
| `POST`   | `/api/accounts/:id/test`      | โ   | ุงุฎุชุจุงุฑ ุงุชุตุงู ุงูุญุณุงุจ   |
| `POST`   | `/api/accounts/:id/reconnect` | โ   | ุฅุนุงุฏุฉ ุฑุจุท (Reauth)    |
| `POST`   | `/api/accounts/sync-all`      | โ   | ูุฒุงููุฉ ุงููู           |
| `GET`    | `/api/accounts/oauth/url`     | โ   | ุฑุงุจุท OAuth ูุญุณุงุจ ุฌุฏูุฏ |
| `GET`    | `/api/accounts/reauth/:id`    | โ   | ุฅุนุงุฏุฉ ุฑุจุท ูู ุงูุฅูููู  |
| `GET`    | `/api/accounts/:id/messages`  | โ   | ุณุฌู ุฑุณุงุฆู ุงูุญุณุงุจ      |

#### `GET /api/accounts`

```
GET /api/accounts?status=CONNECTED&page=1&limit=50
```

```json
// Response
{
  "success": true,
  "data": {
    "accounts": [...],
    "pagination": { "page": 1, "limit": 50, "total": 10, "pages": 1 }
  }
}
```

#### `POST /api/accounts`

```json
// Request
{ "email": "user@outlook.com" }

// Response
{
  "success": true,
  "data": {
    "account": { "id": "...", "email": "user@outlook.com", "status": "PENDING" },
    "connectUrl": "https://login.microsoftonline.com/..."
  }
}
```

#### `POST /api/accounts/:id/sync`

```json
// Response
{
  "success": true,
  "data": {
    "messagesFound": 5,
    "messagesForwarded": 4,
    "messagesFailed": 0,
    "messagesSkipped": 1,
    "errors": []
  }
}
```

---

### ููุญุฉ ุงูุชุญูู โ `/api/dashboard`

| Method | Endpoint                           | Auth | ุงููุตู                    |
| ------ | ---------------------------------- | ---- | ------------------------ |
| `GET`  | `/api/dashboard/stats`             | โ   | ุฅุญุตุงุฆูุงุช ุนุงูุฉ            |
| `GET`  | `/api/dashboard/accounts-overview` | โ   | ููุฎุต ุงูุญุณุงุจุงุช ุญุณุจ ุงูุญุงูุฉ |
| `GET`  | `/api/dashboard/recent-activity`   | โ   | ุขุฎุฑ ุงููุดุงุทุงุช             |
| `GET`  | `/api/dashboard/health`            | โ   | ูุญุต ุตุญุฉ ุงููุธุงู           |
| `GET`  | `/api/dashboard/config`            | โ   | ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ        |
| `POST` | `/api/dashboard/config`            | โ   | ุชุญุฏูุซ ุจุฑูุฏ ุงูุชูุฌูู       |
| `GET`  | `/api/dashboard/worker-status`     | โ   | ุญุงูุฉ ุงูู Worker          |
| `POST` | `/api/dashboard/sync-all`          | โ   | ูุฒุงููุฉ ุงููู              |
| `POST` | `/api/dashboard/retry-failed`      | โ   | ุฅุนุงุฏุฉ ูุญุงููุฉ ุงููุงุดูุฉ     |
| `POST` | `/api/dashboard/test-forward`      | โ   | ุงุฎุชุจุงุฑ ุงูุชูุฌูู           |

#### `GET /api/dashboard/stats`

```json
{
  "success": true,
  "data": {
    "accounts": { "total": 10, "connected": 8, "needsReauth": 1, "error": 1 },
    "messages": { "total": 500, "forwarded": 490, "failed": 10 }
  }
}
```

#### `GET /api/dashboard/health`

```json
{
  "success": true,
  "data": {
    "status": "healthy", // "healthy" | "degraded"
    "database": true,
    "uptime": 86400,
    "memory": { "rss": "...", "heapUsed": "..." },
    "accounts": 10,
    "messages": 500,
    "pending": 5
  }
}
```

---

### ุงูุณุฌูุงุช โ `/api/logs`

| Method   | Endpoint              | Auth | ุงููุตู                    |
| -------- | --------------------- | ---- | ------------------------ |
| `GET`    | `/api/logs`           | โ   | ุณุฌูุงุช ุงูุฑุณุงุฆู            |
| `GET`    | `/api/logs/:id`       | โ   | ุชูุงุตูู ุณุฌู ูุงุญุฏ          |
| `POST`   | `/api/logs/:id/retry` | โ   | ุฅุนุงุฏุฉ ูุญุงููุฉ ุฑุณุงูุฉ ูุงุดูุฉ |
| `DELETE` | `/api/logs/cleanup`   | โ   | ุชูุธูู ุงูุณุฌูุงุช ุงููุฏููุฉ    |

#### `GET /api/logs`

```
GET /api/logs?status=FAILED&accountId=xxx&page=1&limit=50&date=2026-02-06&search=invoice
```

#### `DELETE /api/logs/cleanup`

```
DELETE /api/logs/cleanup?olderThanDays=30
```

```json
{
  "success": true,
  "data": {
    "count": 150, // ุฅุฌูุงูู ุงููุญุฐูู
    "deletedSystemLogs": 100,
    "deletedMessageLogs": 50
  }
}
```

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุฌุฏุงูู

#### `admin_users` โ ุญุณุงุจุงุช ุงูุฃุฏูู

| ุงูุญูู      | ุงูููุน         | ุงููุตู                           |
| ---------- | ------------- | ------------------------------- |
| `id`       | UUID          | ุงููุนุฑู                          |
| `email`    | String (ูุฑูุฏ) | ุจุฑูุฏ ุงูุฃุฏูู                     |
| `password` | String        | ูููุฉ ูุฑูุฑ ูุดูุฑุฉ (bcrypt)        |
| `name`     | String?       | ุงูุงุณู                           |
| `role`     | String        | ุงูุฏูุฑ (`admin` / `SUPER_ADMIN`) |
| `isActive` | Boolean       | ูุดุท ุฃู ูุง                       |

#### `mail_accounts` โ ุญุณุงุจุงุช ุงูุจุฑูุฏ ุงููุฑุจูุทุฉ

| ุงูุญูู           | ุงูููุน         | ุงููุตู                                                  |
| --------------- | ------------- | ------------------------------------------------------ |
| `id`            | UUID          | ุงููุนุฑู                                                 |
| `email`         | String (ูุฑูุฏ) | ุจุฑูุฏ ุงูุญุณุงุจ                                            |
| `msUserId`      | String?       | ูุนุฑู ุงููุณุชุฎุฏู ูู Microsoft                             |
| `displayName`   | String?       | ุงูุงุณู ุงููุนุฑูุถ                                          |
| `status`        | Enum          | ุงูุญุงูุฉ (PENDING/CONNECTED/NEEDS_REAUTH/ERROR/DISABLED) |
| `lastSyncAt`    | DateTime?     | ุขุฎุฑ ูุฒุงููุฉ                                             |
| `lastMessageAt` | DateTime?     | ุขุฎุฑ ุฑุณุงูุฉ                                              |
| `lastError`     | Text?         | ุขุฎุฑ ุฎุทุฃ                                                |
| `errorCount`    | Int           | ุนุฏุฏ ุงูุฃุฎุทุงุก ุงููุชุชุงููุฉ                                  |
| `isEnabled`     | Boolean       | ููุนูู ุฃู ูุง                                            |

#### `mail_tokens` โ ุชูููุงุช OAuth ุงููุดูุฑุฉ

| ุงูุญูู          | ุงูููุน         | ุงููุตู                |
| -------------- | ------------- | -------------------- |
| `id`           | UUID          | ุงููุนุฑู               |
| `accountId`    | String (ูุฑูุฏ) | โ `mail_accounts.id` |
| `accessToken`  | Text          | ูุดูุฑ AES-256         |
| `refreshToken` | Text          | ูุดูุฑ AES-256         |
| `expiresAt`    | DateTime      | ููุช ุงูุชูุงุก ุงูุตูุงุญูุฉ  |

#### `mail_sync_state` โ ุญุงูุฉ ุงููุฒุงููุฉ

| ุงูุญูู         | ุงูููุน         | ุงููุตู                                        |
| ------------- | ------------- | -------------------------------------------- |
| `id`          | UUID          | ุงููุนุฑู                                       |
| `accountId`   | String (ูุฑูุฏ) | โ `mail_accounts.id`                         |
| `deltaLink`   | Text?         | ุฑุงุจุท Delta ูู Graph API (ูููุฒุงููุฉ ุงูุชุฒุงูุฏูุฉ) |
| `lastDeltaAt` | DateTime?     | ุขุฎุฑ ุงุณุชุฎุฏุงู ููู Delta                        |

#### `mail_message_log` โ ุณุฌู ุงูุฑุณุงุฆู

| ุงูุญูู               | ุงูููุน   | ุงููุตู                                  |
| ------------------- | ------- | -------------------------------------- |
| `id`                | UUID    | ุงููุนุฑู                                 |
| `accountId`         | String  | โ `mail_accounts.id`                   |
| `graphMessageId`    | String  | ูุนุฑู ุงูุฑุณุงูุฉ ูู Graph                  |
| `internetMessageId` | String? | ูุนุฑู RFC822                            |
| `subject`           | Text?   | ุงูููุถูุน                                |
| `fromAddress`       | String? | ุงููุฑุณู                                 |
| `toAddresses`       | Text?   | ุงููุณุชูููู (comma-separated)            |
| `forwardStatus`     | Enum    | PENDING / FORWARDED / FAILED / SKIPPED |
| `attempts`          | Int     | ุนุฏุฏ ุงููุญุงููุงุช                          |
| `error`             | Text?   | ุฑุณุงูุฉ ุงูุฎุทุฃ                            |

#### `system_logs` โ ุณุฌูุงุช ุงููุธุงู

| ุงูุญูู      | ุงูููุน  | ุงููุตู                                   |
| ---------- | ------ | --------------------------------------- |
| `id`       | UUID   | ุงููุนุฑู                                  |
| `level`    | String | info / warn / error                     |
| `category` | String | auth / sync / forward / system / CONFIG |
| `message`  | Text   | ูุต ุงูุฑุณุงูุฉ                              |
| `metadata` | JSON?  | ุจูุงูุงุช ุฅุถุงููุฉ                           |

#### `job_states` โ ุญุงูุฉ ุงููุธุงุฆู

| ุงูุญูู       | ุงูููุน         | ุงููุตู                                           |
| ----------- | ------------- | ----------------------------------------------- |
| `id`        | UUID          | ุงููุนุฑู                                          |
| `accountId` | String (ูุฑูุฏ) | ูุนุฑู ุงูุญุณุงุจ                                     |
| `jobId`     | String?       | ูุนุฑู Bull Job                                   |
| `status`    | String        | idle / queued / processing / completed / failed |

### ุงูุนูุงูุงุช

- ุญุฐู `MailAccount` ูุญุฐู ุชููุงุฆูุงู: `MailToken` + `MailSyncState` + `MailMessageLog` (Cascade Delete)

---

## โ๏ธ ุงูุฎุฏูุงุช ุงูุฏุงุฎููุฉ

### `microsoftAuth.service.js` โ ุฎุฏูุฉ ุงููุตุงุฏูุฉ

| ุงููุธููุฉ                             | ุงููุตู                                   |
| ----------------------------------- | --------------------------------------- |
| `generateAuthUrl(accountId)`        | ููููุฏ ุฑุงุจุท OAuth ูู Microsoft           |
| `exchangeCodeForTokens(code)`       | ูุณุชุจุฏู ุงูููุฏ ุจุชูููุงุช                    |
| `refreshAccessToken(refreshToken)`  | ูุฌุฏุฏ ุงูู Access Token                   |
| `getUserProfile(accessToken)`       | ูุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู Graph           |
| `storeTokens(accountId, tokenData)` | ูุญูุธ ุงูุชูููุงุช ูุดูุฑุฉ ูู ุงูู DB           |
| `getValidAccessToken(accountId)`    | ูุฌูุจ ุชููู ุตุงูุญ (ูุฌุฏุฏ ุชููุงุฆูุงู ูู ููุชูู) |
| `completeOAuthFlow(code, state)`    | ูููู ุนูููุฉ ุงูุฑุจุท ุงููุงููุฉ                |

### `graph.service.js` โ ุฎุฏูุฉ Microsoft Graph API

| ุงููุธููุฉ                                                  | ุงููุตู                                  |
| -------------------------------------------------------- | -------------------------------------- |
| `initializeDelta(accountId)`                             | ุฃูู ูุฒุงููุฉ โ ูุฌูุจ ูู ุฑุณุงุฆู ุงูู Inbox   |
| `getDeltaMessages(accountId)`                            | ูุฒุงููุฉ ุชุฒุงูุฏูุฉ โ ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ ููุท   |
| `getMessage(accountId, messageId)`                       | ุฌูุจ ุฑุณุงูุฉ ูุงููุฉ ูุน ุงููุฑููุงุช            |
| `getMessageAttachments(accountId, messageId)`            | ุฌูุจ ุงููุฑููุงุช                           |
| `forwardMessage(accountId, messageId, toEmail, comment)` | **ุชูุฌูู ุงูุฑุณุงูุฉ ูุจุงุดุฑุฉ** ุนุจุฑ Graph API |
| `testConnection(accountId)`                              | ุงุฎุชุจุงุฑ ุตูุงุญูุฉ ุงูุชููู                   |

### `forwarder.service.js` โ ุฎุฏูุฉ ุงูุชูุฌูู

| ุงููุธููุฉ                                                    | ุงููุตู                               |
| ---------------------------------------------------------- | ----------------------------------- |
| `forwardGraphMessage(message, [], fromAccount, accountId)` | ููุฌูู ุงูุฑุณุงูุฉ ุนุจุฑ Graph API Forward |
| `logForward(accountId, message, status, error)`            | ูุณุฌู ูุชูุฌุฉ ุงูุชูุฌูู ูู ุงูู DB        |
| `getFailedMessages(limit)`                                 | ูุฌูุจ ุงูุฑุณุงุฆู ุงููุงุดูุฉ ููุฅุนุงุฏุฉ        |
| `sendReauthNotification(email, accountId, error)`          | ูุฑุณู ุฅูููู ุชูุจูู ูุฅุนุงุฏุฉ ุงูุฑุจุท       |

### `sync.service.js` โ ุฎุฏูุฉ ุงููุฒุงููุฉ (ุงูููุณูู)

| ุงููุธููุฉ                                                   | ุงููุตู                                    |
| --------------------------------------------------------- | ---------------------------------------- |
| `processMessage(message, accountId, email, forwardedIds)` | ูุนุงูุฌุฉ ุฑุณุงูุฉ ูุงุญุฏุฉ (ุฌูุจ + ุชูุฌูู + ุชุณุฌูู) |
| `syncMailbox(accountId)`                                  | ูุฒุงููุฉ ูููุจููุณ ูุงูู                      |
| `syncAllMailboxes()`                                      | ูุฒุงููุฉ ูู ุงูุญุณุงุจุงุช                       |
| `retryFailedMessages()`                                   | ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุฑุณุงุฆู ุงููุงุดูุฉ             |
| `getStatistics()`                                         | ุฅุญุตุงุฆูุงุช ุนุงูุฉ                            |

---

## ๐ ุขููุฉ ุงูุนูู

### ุฏูุฑุฉ ุงููุฒุงููุฉ (ูู 30 ุซุงููุฉ)

```
1. Worker ูุณุฃู: ุฃู ุงูุญุณุงุจุงุช CONNECTED + isEnabledุ
           โ
2. ููู ุญุณุงุจ โ ูุถูู Job ูู Bull Queue
           โ
3. ุงูู Queue ูุนุงูุฌ ูู Job:
   โโโ ูุฌูุจ ุชููู ุตุงูุญ (ูุฌุฏุฏ ูู ูุงุฒู)
   โโโ ูุทูุจ Delta messages ูู Graph API
   โโโ ูููุชุฑ ุงูุฑุณุงุฆู ุงูููุฑุฑุฉ (ูู ุงูู DB)
   โโโ ููู ุฑุณุงูุฉ ุฌุฏูุฏุฉ:
   โ   โโโ ุชุฃุฎูุฑ 300ms
   โ   โโโ ุฌูุจ ุชูุงุตูู ุงูุฑุณุงูุฉ
   โ   โโโ Forward ุนุจุฑ Graph API
   โ   โโโ ุชุฃุฎูุฑ 500ms
   โ   โโโ ุชุณุฌูู ูู ุงูู DB
   โโโ ุชุญุฏูุซ ุขุฎุฑ ููุช ูุฒุงููุฉ
           โ
4. ุจุนุฏ ูู ุงูุญุณุงุจุงุช โ ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุฑุณุงุฆู ุงููุงุดูุฉ
```

### ุฅุฏุงุฑุฉ ุงูุชูููุงุช

```
ุทูุจ Access Token
       โ
       โโโ ุตุงูุญ (ูู ููุชูู)ุ โ ุงุณุชุฎุฏูู
       โ
       โโโ ููุชููุ โ ุฌุฏูุฏู ุจุงูู Refresh Token
       โ   โโโ ูุฌุญุ โ ุงุญูุธ ุงูุฌุฏูุฏ ูุงุณุชุฎุฏูู
       โ   โโโ ูุดูุ โ ุญุงูุฉ ุงูุญุณุงุจ = NEEDS_REAUTH
       โ              โโโ ุฃุฑุณู ุฅูููู ุชูุจูู ููุฃุฏูู
       โ              โโโ ุงูุญุณุงุจ ูุชููู ุนู ุงููุฒุงููุฉ
       โ
       โโโ ูุง ูู ุชูููุ โ ุฎุทุฃ
```

### ุฅุนุงุฏุฉ ุงูุฑุจุท (Reauth)

```
1. ุงูุฃุฏูู ูุถุบุท "Reconnect" ูู ุงููุงุฌูุฉ
   ุฃู ูุถุบุท ุนูู ุงูุฑุงุจุท ูู ุฅูููู ุงูุชูุจูู
                โ
2. ูุชู ุงูุชุญููู ูุตูุญุฉ Microsoft OAuth
                โ
3. ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู ูุงูููุงููุฉ
                โ
4. Callback โ ุชุญุฏูุซ ุงูุชูููุงุช โ ุงูุญุงูุฉ = CONNECTED
```

---

## โฑ๏ธ Rate Limits ูุงูุชุฃุฎูุฑุงุช

### ุญุฏูุฏ Microsoft Graph API

| ุงูุญุฏ              | ุงููููุฉ             |
| ----------------- | ------------------ |
| ุทูุจุงุช API / ุฏูููุฉ | 10,000 ููู ุชุทุจูู   |
| ุทูุจุงุช API / ุซุงููุฉ | 4 ููู ูุณุชุฎุฏู       |
| ุฅููููุงุช / ููู     | 10,000 ููู ูููุจููุณ |

### ุงูุชุฃุฎูุฑุงุช ุงููุฏูุฌุฉ ูู ุงููุธุงู

| ุงูููุงู                     | ุงูุชุฃุฎูุฑ                    | ูุงุจู ููุชุนุฏูู                 |
| -------------------------- | -------------------------- | ---------------------------- |
| ูุจู ุฌูุจ ุชูุงุตูู ูู ุฑุณุงูุฉ    | 300ms                      | ูู ุงูููุฏ                     |
| ุจุนุฏ ูู Forward             | 500ms                      | `FORWARD_DELAY_MS` ูู `.env` |
| ุจูู ูู Batch ูู ุงูุฑุณุงุฆู    | 500ms                      | ูู ุงูููุฏ                     |
| ุจูู ูุญุงููุงุช ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู  | 800ms                      | ูู ุงูููุฏ                     |
| Batch size ูููุนุงูุฌุฉ        | 2 ุฑุณุงุฆู                    | ูู ุงูููุฏ                     |
| ูุญุงููุงุช ุฅุนุงุฏุฉ ุนูุฏ ุฎุทุฃ 429  | ููุชุธุฑ `Retry-After` header | ุชููุงุฆู                       |
| ูุญุงููุงุช ุฅุนุงุฏุฉ ุนูุฏ ุฎุทุฃ 500+ | Exponential backoff        | ุชููุงุฆู                       |

---

## ๐๏ธ ุงูุญุฐู ูุงูุชูุธูู

### ุญุฐู ุญุณุงุจ ุจุฑูุฏ

```
DELETE /api/accounts/:id
```

> ูุญุฐู: ุงูุญุณุงุจ + ุงูุชูููุงุช + ุญุงูุฉ ุงููุฒุงููุฉ + ูู ุณุฌูุงุช ุงูุฑุณุงุฆู (Cascade)

### ุชูุธูู ุงูุณุฌูุงุช ุงููุฏููุฉ

```
DELETE /api/logs/cleanup?olderThanDays=30
```

> ูุญุฐู: ุณุฌูุงุช ุงููุธุงู + ุณุฌูุงุช ุงูุฑุณุงุฆู ุงูุฃูุฏู ูู 30 ููู

### ุฅุนุงุฏุฉ ุชููุฆุฉ ูุงููุฉ

```bash
# ุญุฐู ูู ุงูุจูุงูุงุช ูุฅุนุงุฏุฉ ุฅูุดุงุก ุงูุฌุฏุงูู
npx prisma db push --force-reset

# ุฅุนุงุฏุฉ ุฅูุดุงุก ุญุณุงุจ ุงูุฃุฏูู
npm run db:seed
```

### ูุณุญ Redis Queue

```bash
# ูู Redis CLI
redis-cli FLUSHDB
```

### ุญุฐู ูููุงุช ุงูู Logs

```bash
# ุญุฐู ูููุงุช ุงูุณุฌูุงุช
rm -rf logs/*.log
```

---

## ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงูุญุณุงุจ ูุธูุฑ NEEDS_REAUTH

| ุงูุณุจุจ                          | ุงูุญู                                       |
| ------------------------------ | ------------------------------------------ |
| ุงูุชูุช ุตูุงุญูุฉ ุงูู Refresh Token | ุงุถุบุท "Reconnect" ูู ุตูุญุฉ ุงูุญุณุงุจุงุช          |
| ุงููุณุชุฎุฏู ุบููุฑ ูููุฉ ุงููุฑูุฑ      | ุงุถุบุท "Reconnect"                           |
| ุงูุตูุงุญูุงุช ุชู ุณุญุจูุง             | ุฃุนูุฏ ุงูุฑุจุท ูุชุฃูุฏ ูู ุงูููุงููุฉ ุนูู ุงูุตูุงุญูุงุช |

### ุงูุญุณุงุจ ูุธูุฑ ERROR

| ุงูุณุจุจ                     | ุงูุญู                              |
| ------------------------- | --------------------------------- |
| 5 ุฃุฎุทุงุก ูุชุชุงููุฉ           | ุฑุงุฌุน `lastError` ูู ุชูุงุตูู ุงูุญุณุงุจ |
| ูุดููุฉ ูู ุงูุดุจูุฉ           | ุฃุนุฏ ุงููุญุงููุฉ โ ุงุถุบุท "Sync"        |
| ุงูุญุณุงุจ ูุญุฐูู ูู Microsoft | ุงุญุฐู ุงูุญุณุงุจ ูุฃุถูู ูู ุฌุฏูุฏ         |

### ุงูู Worker ูุง ูุนูู

| ุงูุณุจุจ          | ุงูุญู                   |
| -------------- | ---------------------- |
| Redis ุบูุฑ ูุชุตู | ุดุบูู Redis ุฃููุงู       |
| ุฎุทุฃ ูู ุงูู DB  | ุชุฃูุฏ ูู `DATABASE_URL` |
| ูุง ููุฌุฏ ุญุณุงุจุงุช | ุฃุถู ุญุณุงุจ ูู ุงููุงุฌูุฉ    |

### ุฑุณุงุฆู ูุง ุชุชุญูู

| ุงูุณุจุจ                         | ุงูุญู                              |
| ----------------------------- | --------------------------------- |
| ุตูุงุญูุฉ `Mail.Send` ุบูุฑ ููุฌูุฏุฉ | ุฃุถููุง ูู Azure + ุฃุนุฏ ุฑุจุท ุงูุญุณุงุจุงุช |
| `FORWARD_TO_EMAIL` ุฎุทุฃ        | ุตุญุญู ูู ุงูุฅุนุฏุงุฏุงุช                 |
| ุงูุฑุณุงูุฉ ููุฑุฑุฉ                 | ุทุจูุนู โ ูุชู ุชุฎุทููุง (`SKIPPED`)    |

### ุฎุทุฃ 429 (Too Many Requests)

| ุงูุณุจุจ        | ุงูุญู                                          |
| ------------ | --------------------------------------------- |
| ูุซุฑุฉ ุงูุทูุจุงุช | ุงููุธุงู ูุนุงูุฌู ุชููุงุฆูุงู (ููุชุธุฑ ููุนูุฏ ุงููุญุงููุฉ) |
| ุญุณุงุจุงุช ูุซูุฑุฉ | ุฒูุฏ `FORWARD_DELAY_MS` ู `POLL_INTERVAL_MS`   |

---

## ๐ ูููู ุงููููุงุช

```
mail/
โโโ .env                          # ุฅุนุฏุงุฏุงุช ุงูุจูุฆุฉ (ูุง ุชุฑูุนู ูู Git!)
โโโ .env.example                  # ูููุฐุฌ ุงูุฅุนุฏุงุฏุงุช
โโโ package.json                  # ุงูุงุนุชูุงุฏูุงุช ูุงูุฃูุงูุฑ
โ
โโโ prisma/
โ   โโโ schema.prisma             # ุชุนุฑูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ   โโโ seed.js                   # ุฅูุดุงุก ุญุณุงุจ ุงูุฃุฏูู ุงูุงูุชุฑุงุถู
โ   โโโ migrations/               # ูููุงุช ุงูู Migration
โ
โโโ scripts/
โ   โโโ setup.js                  # ุณูุฑุจุช ุงูุฅุนุฏุงุฏ ุงูุชููุงุฆู
โ
โโโ src/
โ   โโโ server.js                 # ุงูุณูุฑูุฑ ุงูุฑุฆูุณู (Express)
โ   โโโ worker.js                 # ุนูููุฉ ุงููุฒุงููุฉ (Bull Queue)
โ   โ
โ   โโโ config/
โ   โ   โโโ index.js              # ูู ุงูุฅุนุฏุงุฏุงุช (ูู .env)
โ   โ   โโโ database.js           # Prisma Client
โ   โ   โโโ logger.js             # Winston Logger
โ   โ
โ   โโโ middleware/
โ   โ   โโโ auth.middleware.js    # JWT Authentication + Role check
โ   โ   โโโ error.middleware.js   # Error handling + Prisma errors
โ   โ
โ   โโโ routes/
โ   โ   โโโ auth.routes.js        # /api/auth/*
โ   โ   โโโ accounts.routes.js    # /api/accounts/*
โ   โ   โโโ dashboard.routes.js   # /api/dashboard/*
โ   โ   โโโ logs.routes.js        # /api/logs/*
โ   โ
โ   โโโ services/
โ   โ   โโโ microsoftAuth.service.js  # OAuth 2.0 (ุชูููุงุช + ุฑุจุท)
โ   โ   โโโ graph.service.js          # Graph API (ุฑุณุงุฆู + forward)
โ   โ   โโโ forwarder.service.js      # ุฅุนุงุฏุฉ ุงูุชูุฌูู + ุงูุชุณุฌูู
โ   โ   โโโ sync.service.js           # ุงูููุณูู (ูุฒุงููุฉ + ุฅุนุงุฏุฉ ูุญุงููุฉ)
โ   โ
โ   โโโ utils/
โ       โโโ ApiError.js           # Custom error class
โ       โโโ asyncHandler.js       # Async route wrapper
โ       โโโ encryption.js        # AES-256 ุชุดููุฑ/ูู ุชุดููุฑ
โ
โโโ public/                       # ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (Static)
โ   โโโ index.html                # ุตูุญุฉ ุงูุฏุฎูู
โ   โโโ dashboard.html            # ููุญุฉ ุงูุชุญูู
โ   โโโ accounts.html             # ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช
โ   โโโ logs.html                 # ุงูุณุฌูุงุช
โ   โโโ settings.html             # ุงูุฅุนุฏุงุฏุงุช
โ   โโโ oauth-callback.html       # ูุชูุฌุฉ OAuth
โ   โ
โ   โโโ css/
โ   โ   โโโ style.css             # ุงูุฃููุงุท ุงูุฑุฆูุณูุฉ
โ   โ   โโโ styles.css            # ุฃููุงุท ุฅุถุงููุฉ
โ   โ
โ   โโโ js/
โ       โโโ api.js                # HTTP client (fetch + auth header)
โ       โโโ auth.js               # ุฅุฏุงุฑุฉ ุงูุฌูุณุฉ (localStorage)
โ       โโโ login.js              # ููุทู ุชุณุฌูู ุงูุฏุฎูู
โ       โโโ dashboard.js          # ููุทู ููุญุฉ ุงูุชุญูู
โ       โโโ accounts.js           # ููุทู ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช
โ       โโโ logs.js               # ููุทู ุงูุณุฌูุงุช
โ       โโโ settings.js           # ููุทู ุงูุฅุนุฏุงุฏุงุช
โ       โโโ oauth-callback.js     # ููุทู OAuth callback
โ       โโโ modal.js              # ูุธุงู ุงูููุงูุฐ ุงูููุจุซูุฉ
โ       โโโ ui.js                 # ุฃุฏูุงุช ุงููุงุฌูุฉ ุงูุนุงูุฉ
โ
โโโ logs/                         # ูููุงุช ุงูุณุฌูุงุช (Winston)
    โโโ app.log                   # ูู ุงูุณุฌูุงุช
    โโโ error.log                 # ุงูุฃุฎุทุงุก ููุท
```

---

## ๐ ุงูุฃูุงู

| ุงูููุฒุฉ               | ุงูุชูุงุตูู                                           |
| -------------------- | -------------------------------------------------- |
| **ุชุดููุฑ ุงูุชูููุงุช**   | AES-256 โ ูู Access/Refresh tokens ูุดูุฑุฉ ูู ุงูู DB |
| **ูููุงุช ุงููุฑูุฑ**     | bcrypt ูุน 12 rounds                                |
| **JWT**              | ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู ุจุชููู ููููุน                      |
| **Helmet**           | ุญูุงูุฉ HTTP headers                                 |
| **Rate Limiting**    | 100 ุทูุจ / 15 ุฏูููุฉ ุนูู `/api`                      |
| **CORS**             | ูุญุฏูุฏ ุจู `FRONTEND_URL` ููุท                        |
| **Input Validation** | ูุญุต ุงููุฏุฎูุงุช ูู ูู ุงูู endpoints                   |

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูู SMTP ูู ูุนูุฏ ูุทููุจุงู** โ ุงูุชูุฌูู ูุชู ูุจุงุดุฑุฉ ุนุจุฑ Graph API
2. **ูุงุฒู Redis ูููู ุดุบุงู** ูุจู ุชุดุบูู ุงูู Worker
3. **ุจุนุฏ ุฅุถุงูุฉ `Mail.Send`** ูู Azure โ ูุงุฒู ุฅุนุงุฏุฉ ุฑุจุท ูู ุงูุญุณุงุจุงุช
4. **ููู `.env` ุณุฑู** โ ูุง ุชุฑูุนู ูู Git ุฃุจุฏุงู
5. **ุงูุฃุฏูู ุงูุงูุชุฑุงุถู** โ ุบููุฑ ูููุฉ ุงููุฑูุฑ ููุฑุงู ุจุนุฏ ุฃูู ุฏุฎูู
6. **Prisma Studio** โ ุฃุฏุงุฉ ูููุฏุฉ ูุงุณุชุนุฑุงุถ ุงูุจูุงูุงุช: `npm run db:studio`
